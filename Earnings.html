<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ’° MTurk Earnings Monitor (Qualified + Transferred)</title>

<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  initializeFirestore,
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ======================================================
   FIREBASE CONFIG
====================================================== */
const earningsConfig = {
  apiKey: "AIzaSyBTFpM3fs7kWBrZL4yOi9tquUTp1HhH7L8",
  authDomain: "mturk-monitordeep.firebaseapp.com",
  projectId: "mturk-monitordeep",
  storageBucket: "mturk-monitordeep.firebasestorage.app",
  messagingSenderId: "505786000194",
  appId: "1:505786000194:web:40b9c9df75d3125f3a99cd"
};

const earningsApp = initializeApp(earningsConfig, "earningsApp");
const earningsDB = initializeFirestore(earningsApp, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});

/* ======================================================
   CONSTANTS + STATE
====================================================== */
const CACHE_KEY      = "earnings_cache_data";
const SYNC_KEY       = "earnings_last_sync";
const TRANSFERS_KEY  = "earnings_transfers_cache";

let QUALIFIED_DATA   = [];
let TRANSFERRED_DATA = [];

/* ======================================================
   GENERIC HELPERS
====================================================== */
function today() {
  return new Date().toISOString().slice(0,10);
}

function needsSync() {
  return localStorage.getItem(SYNC_KEY) !== today();
}

function markSynced() {
  localStorage.setItem(SYNC_KEY, today());
}

function cleanCell(v) {
  return String(v ?? "").trim().replace(/^"+|"+$/g, "");
}

/* Supports:
   - 11/17/25
   - 11/17/2025
   - Nov 30, 2025
   - 11/18/2025, 7:17:04 AM
*/
function parseAnyDate(dateStr) {
  if (!dateStr) return null;
  const s = String(dateStr).trim();
  if (!s) return null;

  if (s.includes("/")) {
    const main = s.split(",")[0].trim(); // remove time part safely
    const p = main.split("/");
    if (p.length === 3) {
      const m = parseInt(p[0], 10);
      const d = parseInt(p[1], 10);
      let y = parseInt(p[2], 10);
      if (Number.isNaN(m) || Number.isNaN(d) || Number.isNaN(y)) return null;
      if (y < 100) y = 2000 + y;
      const dt = new Date(y, m - 1, d);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }
  }

  const t = Date.parse(s);
  return Number.isNaN(t) ? null : new Date(t);
}

/* âœ… FIXED RULE:
   Transfer date should be day >= 6 (NO current-month restriction)
*/
function isAfterSixth(dateStr) {
  const dt = parseAnyDate(dateStr);
  if (!dt) return false;
  return dt.getDate() >= 6;
}

/* Active until 6th of next month */
function isTransferActive(dateStr) {
  const dt = parseAnyDate(dateStr);
  if (!dt) return false;
  const cutoff = new Date(dt.getFullYear(), dt.getMonth() + 1, 6, 0, 0, 0, 0);
  return new Date() < cutoff;
}

/* ======================================================
   TRANSFERS CACHE (localStorage)
====================================================== */
function loadTransfersCache() {
  return JSON.parse(localStorage.getItem(TRANSFERS_KEY) || "[]");
}

function saveTransfersCache(arr) {
  localStorage.setItem(TRANSFERS_KEY, JSON.stringify(arr));
}

/*
  Refresh transfers cache from Firestore (ONLY on daily sync)
  - Keep only ACTIVE transfers
  - Add NEW transfers from Firestore if:
      * in Qualified sheet
      * lastTransferAmount > 0
      * lastTransferDate day >= 6
      * active until next month 6th
  - Never remove active ones because Firestore changed
*/
function refreshTransfersCacheFromFirestore(allDocs, users, workers) {
  // 1) Keep only active cached transfers
  let cache = loadTransfersCache().filter(t => isTransferActive(t.date));

  // 2) If not syncing today, do NOT read Firestore again
  if (!needsSync()) {
    saveTransfersCache(cache);
    return cache;
  }

  // 3) Daily sync: add new transfers
  for (const d of allDocs) {
    const user = cleanCell(d.user);
    const wid  = cleanCell(d.workerId);

    // only from Qualified sheet
    if (!users.has(user) && !workers.has(wid)) continue;

    const lt = parseFloat(d.lastTransferAmount) || 0;
    const dt = d.lastTransferDate || "";

    if (!lt || lt < 0.01) continue;

    // âœ… day >= 6
    if (!isAfterSixth(dt)) continue;

    // must still be active
    if (!isTransferActive(dt)) continue;

    const exists = cache.some(t =>
      cleanCell(t.user) === user &&
      cleanCell(t.workerId) === wid &&
      Number(t.amount) === lt &&
      String(t.date) === String(dt)
    );

    if (!exists) {
      cache.push({ user, workerId: wid, amount: lt, date: dt });
    }
  }

  saveTransfersCache(cache);
  return cache;
}

/* ======================================================
   MAIN CSV (Qualified list) â€“ header-safe
====================================================== */
async function loadMainCSV() {
  const res = await fetch(
    "https://docs.google.com/spreadsheets/d/1W0fYDHy8nePZ-rkqZAX2DVOEufSHe7UJfB7OeC49b1orkqQF1lyCw/export?format=csv&gid=0"
  );
  const text  = await res.text();
  const lines = text.split("\n").map(l => l.trim()).filter(Boolean);

  const users   = new Set();
  const workers = new Set();

  if (lines.length <= 1) return { users, workers };

  const header = lines[0].split(",").map(h => cleanCell(h).toLowerCase());
  const uIdx = header.findIndex(h => h === "user" || h.includes("user"));
  const wIdx = header.findIndex(h => h === "workerid" || h.includes("worker"));

  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split(",");
    const u = cleanCell(cols[uIdx >= 0 ? uIdx : 0]);
    const w = cleanCell(cols[wIdx >= 0 ? wIdx : 1]);
    if (u) users.add(u);
    if (w) workers.add(w);
  }
  return { users, workers };
}

/* ======================================================
   FIRESTORE FETCH (ONCE PER DAY)
====================================================== */
async function fetchFromFirestore() {
  const snap = await getDocs(collection(earningsDB, "earnings_logs"));
  const arr  = [];
  snap.forEach(d => arr.push({ id: d.id, ...d.data() }));

  localStorage.setItem(CACHE_KEY, JSON.stringify(arr));
  markSynced();
  return arr;
}

function loadCache() {
  return JSON.parse(localStorage.getItem(CACHE_KEY) || "[]");
}

/* ======================================================
   COUNTDOWN
====================================================== */
function updateCountdown() {
  const nextSyncEl = document.getElementById("next-sync");
  if (!nextSyncEl) return;

  const now  = new Date();
  const next = new Date();
  next.setHours(24,0,0,0);

  const diff = next - now;
  const h = Math.floor(diff / (1000*60*60));
  const m = Math.floor((diff / (1000*60)) % 60);

  nextSyncEl.innerHTML = `Next Sync: <b>12:00 AM</b> (in ${h}h ${m}m)`;
}

/* ======================================================
   BUILD DATA FOR BOTH TABS
====================================================== */
async function buildData() {
  const loadingEl    = document.getElementById("loading");
  const totalQEl     = document.getElementById("totalQualified");
  const totalTransEl = document.getElementById("totalTransferred");

  loadingEl.style.display = "block";

  const { users, workers } = await loadMainCSV();
  const allDocs = needsSync() ? await fetchFromFirestore() : loadCache();

  const transfersActive = refreshTransfersCacheFromFirestore(allDocs, users, workers);

  QUALIFIED_DATA   = [];
  TRANSFERRED_DATA = [];

  let sumQualifiedCurrent = 0;
  let sumTransfersActive  = 0;

  // Qualified: currentEarnings >= 8
  for (const d of allDocs) {
    const user = cleanCell(d.user);
    const wid  = cleanCell(d.workerId);

    if (!users.has(user) && !workers.has(wid)) continue;

    const current  = parseFloat(d.currentEarnings) || 0;
    const lastDate = d.lastTransferDate || "";
    const nextDate = d.nextTransferDate || lastDate || "â€”";

    if (current >= 8) {
      QUALIFIED_DATA.push({ user, wid, current, nextDate });
      sumQualifiedCurrent += current;
    }
  }

  // Transferred: cache only, still limited to qualified sheet (already), and active
  TRANSFERRED_DATA = transfersActive
    .filter(t => isAfterSixth(t.date) && isTransferActive(t.date))
    .map(t => ({
      user: cleanCell(t.user),
      wid: cleanCell(t.workerId),
      amount: Number(t.amount) || 0,
      date: t.date
    }));

  for (const t of TRANSFERRED_DATA) sumTransfersActive += t.amount;

  QUALIFIED_DATA.sort((a,b)=>b.current - a.current);
  TRANSFERRED_DATA.sort((a,b)=>b.amount - a.amount);

  const finalQualifiedTotal = sumQualifiedCurrent + sumTransfersActive;

  totalQEl.innerHTML =
    `Qualified (current â‰¥ $8 + active transfers): <b>$${finalQualifiedTotal.toFixed(2)}</b> (${QUALIFIED_DATA.length} users)`;

  totalTransEl.innerHTML =
    `Active Transfers (date â‰¥ 6th, kept until next 6th): <b>$${sumTransfersActive.toFixed(2)}</b> (${TRANSFERRED_DATA.length} transfers)`;

  renderQualifiedTable();
  initTransferredFilterAndTable();

  loadingEl.style.display = "none";
}

/* ======================================================
   RENDER â€“ QUALIFIED TAB
====================================================== */
function renderQualifiedTable() {
  const tbody = document.getElementById("qualified-body");
  tbody.innerHTML = "";

  for (const r of QUALIFIED_DATA) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.user}</td>
      <td>${r.wid}</td>
      <td style="color:#15803d;font-weight:bold">${r.current.toFixed(2)}</td>
      <td>${r.nextDate}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ======================================================
   RENDER â€“ TRANSFERRED TAB + DATE FILTER
====================================================== */
function initTransferredFilterAndTable() {
  const select = document.getElementById("transferDateFilter");

  const dates = Array.from(new Set(TRANSFERRED_DATA.map(r => r.date).filter(Boolean)))
    .sort((a,b)=> (parseAnyDate(a)?.getTime() ?? 0) - (parseAnyDate(b)?.getTime() ?? 0));

  select.innerHTML = `<option value="">All Dates</option>`;
  for (const d of dates) {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    select.appendChild(opt);
  }

  select.onchange = () => renderTransferredTable();
  renderTransferredTable();
}

function renderTransferredTable() {
  const tbody = document.getElementById("transferred-body");
  const filterVal = document.getElementById("transferDateFilter").value;
  tbody.innerHTML = "";

  const data = TRANSFERRED_DATA.filter(r => !filterVal || r.date === filterVal);

  if (data.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" style="text-align:center;color:#6b7280;">No records</td>`;
    tbody.appendChild(tr);
    return;
  }

  for (const r of data) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.user}</td>
      <td>${r.wid}</td>
      <td style="color:#b91c1c;font-weight:bold">${r.amount.toFixed(2)}</td>
      <td>${r.date}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ======================================================
   TEAM CSV (Excel Export â€“ all users)
====================================================== */
async function loadTeamCSV() {
  const res = await fetch(
    "https://docs.google.com/spreadsheets/d/1W0fYDHy8nePZ-rkqZAX2DVOEufSHe7UJfB7OeC49b1orkqQF1lyCw/export?format=csv&gid=0"
  );
  const text  = await res.text();
  const lines = text.split("\n").filter(Boolean);

  const teamMap = new Map(); // User â†’ workerId
  for (let i=1;i<lines.length;i++){
    const [user, wid] = lines[i].split(",");
    if (user && wid) teamMap.set(cleanCell(user), cleanCell(wid));
  }
  return teamMap;
}

function buildExcelRows(rawData, teamMap) {
  const rows = [];

  for (const [user, wid] of teamMap.entries()) {
    const match = rawData.find(r => cleanCell(r.workerId) === wid);
    if (!match) continue;

    rows.push({
      "User": user,
      "Worker ID": wid,
      "Current Earnings": match.currentEarnings || "",
      "Last Month Earnings": match.lastMonthEarnings || "",
      "Next Transfer Date": match.nextTransferDate || match.lastTransferDate || "â€”",
      "Last Transfer Amount": match.lastTransferAmount || ""
    });
  }

  return rows;
}

async function exportExcelReport() {
  const teamMap = await loadTeamCSV();
  const all = needsSync() ? await fetchFromFirestore() : loadCache();

  if (!all || all.length === 0) {
    alert("No Firestore data available.");
    return;
  }

  const rows = buildExcelRows(all, teamMap);

  if (rows.length === 0) {
    alert("No matching records found for team sheet.");
    return;
  }

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Earnings");

  XLSX.writeFile(wb, `Daily_Earnings_Report_${today()}.xlsx`);
}

/* ======================================================
   TABS
====================================================== */
function switchTab(tab) {
  const qTabBtn = document.getElementById("tab-qualified");
  const tTabBtn = document.getElementById("tab-transferred");
  const qPanel  = document.getElementById("panel-qualified");
  const tPanel  = document.getElementById("panel-transferred");

  if (tab === "qualified") {
    qTabBtn.classList.add("active-tab");
    tTabBtn.classList.remove("active-tab");
    qPanel.style.display = "block";
    tPanel.style.display = "none";
  } else {
    tTabBtn.classList.add("active-tab");
    qTabBtn.classList.remove("active-tab");
    tPanel.style.display = "block";
    qPanel.style.display = "none";
  }
}

/* ======================================================
   INIT
====================================================== */
window.addEventListener("DOMContentLoaded", () => {
  updateCountdown();
  setInterval(updateCountdown, 60000);

  document.getElementById("downloadExcel").onclick = exportExcelReport;

  document.getElementById("tab-qualified").onclick   = () => switchTab("qualified");
  document.getElementById("tab-transferred").onclick = () => switchTab("transferred");

  switchTab("qualified");
  buildData();
});
</script>

<style>
body { font-family:"Segoe UI",Arial,sans-serif; background:#f8fafc; padding:20px; }
h1 { text-align:center; color:#0f62fe; }
#loading { text-align:center; color:#6b7280; margin-top:10px; }
.summary-bar { text-align:center; font-size:16px; margin-top:10px; }
#next-sync { text-align:center; margin-top:4px; margin-bottom:12px; color:#6b7280; }

/* Tabs */
.tabs { display:flex; justify-content:center; margin:10px 0 15px 0; }
.tab-btn {
  padding:8px 16px; border-radius:999px; border:1px solid #d1d5db;
  background:#e5e7eb; color:#374151; margin:0 4px; cursor:pointer;
  font-size:14px; font-weight:600;
}
.tab-btn.active-tab { background:#0f62fe; color:#ffffff; border-color:#0f62fe; }

/* Tables */
.table-wrap { width:95%; margin:0 auto 20px auto; }
table {
  width:100%; background:#ffffff; border-radius:8px; border-collapse:collapse;
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}
th,td { padding:10px; border-bottom:1px solid #e5e7eb; }
th { background:#0f62fe; color:#ffffff; }

/* Excel button */
.excel-btn {
  background:#0d9488; color:#ffffff; padding:8px 14px; border:none;
  border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;
  margin:10px auto 15px auto; display:inline-block;
}
.excel-btn:hover { background:#0f766e; }

/* Filter */
.filter-bar { margin-bottom:10px; font-size:14px; color:#374151; }
.filter-bar select {
  margin-left:6px; padding:4px 8px; border-radius:6px; border:1px solid #d1d5db; font-size:14px;
}
</style>
</head>
<body>

<h1>ðŸ’° Daily MTurk Earnings Monitor</h1>

<div id="loading">Loading Earningsâ€¦</div>

<div class="summary-bar" id="totalQualified"></div>
<div class="summary-bar" id="totalTransferred"></div>
<div id="next-sync"></div>

<div style="text-align:center;">
  <button id="downloadExcel" class="excel-btn">ðŸ“¥ Download Todayâ€™s Excel Report</button>
</div>

<div class="tabs">
  <button id="tab-qualified" class="tab-btn active-tab">Qualified Users (current â‰¥ $8)</button>
  <button id="tab-transferred" class="tab-btn">Transferred (kept until next 6th)</button>
</div>

<!-- QUALIFIED PANEL -->
<div id="panel-qualified" class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Worker ID</th>
        <th>Current Earnings ($)</th>
        <th>Next Transfer Date</th>
      </tr>
    </thead>
    <tbody id="qualified-body"></tbody>
  </table>
</div>

<!-- TRANSFERRED PANEL -->
<div id="panel-transferred" class="table-wrap" style="display:none;">
  <div class="filter-bar">
    Filter by Transfer Date (date â‰¥ 6th, active until next 6th):
    <select id="transferDateFilter">
      <option value="">All Dates</option>
    </select>
  </div>
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Worker ID</th>
        <th>Transferred Amount ($)</th>
        <th>Transferred Date</th>
      </tr>
    </thead>
    <tbody id="transferred-body"></tbody>
  </table>
</div>

</body>
</html>
