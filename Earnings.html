<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üí∞ MTurk Earnings Monitor (Daily Read-Only)</title>

<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  initializeFirestore,
  collection,
  getDocs,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ======================================================
   FIREBASE CONFIG
====================================================== */
const earningsConfig = {
  apiKey: "AIzaSyBTFpM3fs7kWBrZL4yOi9tquUTp1HhH7L8",
  authDomain: "mturk-monitordeep.firebaseapp.com",
  projectId: "mturk-monitordeep",
  storageBucket: "mturk-monitordeep.firebasestorage.app",
  messagingSenderId: "505786000194",
  appId: "1:505786000194:web:40b9c9df75d3125f3a99cd"
};

const earningsApp = initializeApp(earningsConfig, "earningsApp");
const earningsDB = initializeFirestore(earningsApp, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});

/* ======================================================
   CONSTANTS
====================================================== */
const CACHE_KEY = "earnings_cache_data";
const SYNC_KEY  = "earnings_last_sync";
const UNDO_KEY  = "earnings_undo_history";

/* ======================================================
   HELPERS
====================================================== */
function today() {
  return new Date().toISOString().slice(0,10);
}

function needsSync() {
  return localStorage.getItem(SYNC_KEY) !== today();
}

function markSynced() {
  localStorage.setItem(SYNC_KEY, today());
}

function isThisMonth(dateStr){
  if (!dateStr) return false;
  const p = dateStr.split("/");
  if (p.length !== 3) return false;

  const m = parseInt(p[0], 10);
  const y = 2000 + parseInt(p[2], 10);
  const now = new Date();

  return (m === (now.getMonth()+1) && y === now.getFullYear());
}

function loadUndoHistory() {
  return JSON.parse(localStorage.getItem(UNDO_KEY) || "[]");
}

function saveUndoHistory(list) {
  localStorage.setItem(UNDO_KEY, JSON.stringify(list));
}

/* ======================================================
   FIRESTORE READ + CSV QUALIFIED LIST
====================================================== */
async function loadMainCSV() {
  const res = await fetch(
    "https://docs.google.com/spreadsheets/d/1W0fYDHy8nePZ-rkqZAX2DVOEufSHe7UJfB7OeC49b1o/export?format=csv&gid=0"
  );
  const text  = await res.text();
  const lines = text.split("\n").filter(Boolean);

  const users   = new Set();
  const workers = new Set();

  for (let i=1;i<lines.length;i++){
    const [u, w] = lines[i].split(",");
    if (u) users.add(u.trim());
    if (w) workers.add(w.trim());
  }
  return { users, workers };
}

async function fetchFromFirestore() {
  const snap = await getDocs(collection(earningsDB, "earnings_logs"));
  const arr  = [];
  snap.forEach(d => arr.push({ id: d.id, ...d.data() }));

  localStorage.setItem(CACHE_KEY, JSON.stringify(arr));
  markSynced();
  return arr;
}

function loadCache() {
  return JSON.parse(localStorage.getItem(CACHE_KEY) || "[]");
}

/* ======================================================
   UI HELPERS
====================================================== */
function updateCountdown(nextSyncEl) {
  const now  = new Date();
  const next = new Date();
  next.setHours(24,0,0,0);

  const diff = next - now;
  const h = Math.floor(diff / (1000*60*60));
  const m = Math.floor((diff / (1000*60)) % 60);

  nextSyncEl.innerHTML = `Next Sync: <b>12:00 AM</b> (in ${h}h ${m}m)`;
}

function updateUndoButton() {
  const list = loadUndoHistory();
  const btn  = document.getElementById("undoBtn");
  if (!btn) return;
  btn.disabled = list.length === 0;
  btn.textContent = `‚è™ Undo Deleted Transfers (${list.length})`;
}

function renderUndoPanel() {
  const panel = document.getElementById("undoPanel");
  if (!panel) return;

  const list = loadUndoHistory();
  if (list.length === 0) {
    panel.innerHTML = `
      <div class="undo-header">No deleted transfers</div>
      <div class="undo-body">Nothing to undo.</div>
      <div class="undo-footer">
        <button id="closeUndo" class="undo-close">Close</button>
      </div>
    `;
    return;
  }

  let html = `
    <div class="undo-header">Deleted Transfers</div>
    <div class="undo-body">
      <ul class="undo-list">
  `;

  list.forEach((e, idx) => {
    const amt = e.lastTransferAmount || "0.00";
    const dt  = e.lastTransferDate || "‚Äî";
    const u   = e.user || "(unknown)";
    const w   = e.workerId || e.id || "";

    html += `
      <li>
        <span class="undo-entry">
          <b>${u}</b> (${w}) ‚Äì $${amt} on ${dt}
        </span>
        <button class="undo-item" data-idx="${idx}">Undo</button>
      </li>
    `;
  });

  html += `
      </ul>
    </div>
    <div class="undo-footer">
      <button id="closeUndo" class="undo-close">Close</button>
    </div>
  `;

  panel.innerHTML = html;
}

/* ======================================================
   MAIN BUILD TABLE
====================================================== */
async function buildTable() {
  const loadingEl  = document.getElementById("loading");
  const totalEl    = document.getElementById("total");
  const tbody      = document.getElementById("data-body");

  loadingEl.style.display = "block";

  const { users, workers } = await loadMainCSV();
  const all = needsSync() ? await fetchFromFirestore() : loadCache();

  tbody.innerHTML = "";
  let total = 0;
  const result = [];

  for (const d of all) {
    const user = (d.user || "").trim();
    const wid  = (d.workerId || "").trim();

    if (!users.has(user) && !workers.has(wid)) continue;

    const curr = parseFloat(d.currentEarnings) || 0;
    const lt   = parseFloat(d.lastTransferAmount) || 0;
    const lm   = parseFloat(d.lastMonthEarnings) || 0;

    let amt = curr>0 ? curr : lt>0 ? lt : lm>0 ? lm : 0;
    let next   = d.nextTransferDate || d.lastTransferDate || "‚Äî";
    let status = "Not Yet";

    // RULE 1: earnings dropped
    if (lt > curr && lt >= 8) {
      status = `Transferred $${lt.toFixed(2)}`;
      amt    = lt;
    }
    // RULE 2: transfer in this month
    else if (isThisMonth(d.lastTransferDate) && lt >= 8) {
      status = `Transferred $${lt.toFixed(2)}`;
      amt    = lt;
    }

    if (amt < 8) continue;

    result.push({
      id: d.id,
      user,
      wid,
      amt,
      next,
      status,
      lastTransferAmount: d.lastTransferAmount || "",
      lastTransferDate: d.lastTransferDate || "",
      currentEarnings: d.currentEarnings || "",
      lastMonthEarnings: d.lastMonthEarnings || "",
      nextTransferDate: d.nextTransferDate || "",
      workerId: wid
    });

    total += amt;
  }

  // Transferred first
  result.sort((a,b)=> a.status.includes("Transferred") ? -1 : 1);

  totalEl.innerHTML =
    `Total Earnings (‚â• $8): <b>$${total.toFixed(2)}</b> (${result.length} users)`;

  tbody.innerHTML = "";

  for (const r of result) {
    const isTransferred = r.status.includes("Transferred");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:center;">
        ${
          isTransferred
          ? `<input type="checkbox" class="row-check" data-id="${r.id}">`
          : "‚Äî"
        }
      </td>
      <td>${r.user}</td>
      <td>${r.wid}</td>
      <td style="color:#15803d;font-weight:bold">${r.amt.toFixed(2)}</td>
      <td>${r.next}</td>
      <td style="font-weight:bold;color:${isTransferred ? "#b91c1c" : "#065f46"}">
        ${r.status}
      </td>
      <td>
        ${
          isTransferred
          ? `<button class="del" data-id="${r.id}">üóë</button>`
          : "‚Äî"
        }
      </td>
    `;

    // Single delete handler
    const delBtn = tr.querySelector(".del");
    if (delBtn) {
      delBtn.onclick = async () => {
        if (!confirm(`Remove transfer for ${r.user}?`)) return;

        // store in undo history
        let history = loadUndoHistory().filter(e => e.id !== r.id);
        history.push({
          id: r.id,
          user: r.user,
          workerId: r.wid,
          lastTransferAmount: r.lastTransferAmount,
          lastTransferDate: r.lastTransferDate
        });
        saveUndoHistory(history);
        updateUndoButton();

        // clear transfer fields + reset currentEarnings
        await updateDoc(doc(earningsDB, "earnings_logs", r.id), {
          lastTransferAmount: "",
          lastTransferDate: "",
          currentEarnings: "0"
        });

        localStorage.removeItem(CACHE_KEY);
        localStorage.removeItem(SYNC_KEY);

        alert("Removed from qualified users!");
        buildTable();
      };
    }

    tbody.appendChild(tr);
  }

  loadingEl.style.display = "none";
}

/* ======================================================
   MULTI-DELETE TRANSFERS
====================================================== */
async function multiDeleteTransfers() {
  const checks = [...document.querySelectorAll(".row-check:checked")];

  if (checks.length === 0) {
    alert("Select at least one transferred user.");
    return;
  }

  if (!confirm(`Remove transfers for ${checks.length} user(s)?`)) return;

  let history = loadUndoHistory();

  for (const c of checks) {
    const row  = c.closest("tr");
    const id   = c.dataset.id;
    const user = row.children[1].textContent.trim();
    const wid  = row.children[2].textContent.trim();
    const statusText = row.children[5].textContent.trim();
    const match = statusText.match(/\$([\d.]+)/);
    const amt   = match ? match[1] : "";

    history = history.filter(e => e.id !== id);
    history.push({
      id,
      user,
      workerId: wid,
      lastTransferAmount: amt,
      lastTransferDate: ""   // unknown from UI
    });

    // clear transfer fields + reset currentEarnings
    await updateDoc(doc(earningsDB, "earnings_logs", id), {
      lastTransferAmount: "",
      lastTransferDate: "",
      currentEarnings: "0"
    });
  }

  saveUndoHistory(history);
  updateUndoButton();

  localStorage.removeItem(CACHE_KEY);
  localStorage.removeItem(SYNC_KEY);

  alert("Selected users removed from qualified.");
  buildTable();
}

/* ======================================================
   TEAM CSV (Excel Export)
====================================================== */
async function loadTeamCSV() {
  const res = await fetch(
    "https://docs.google.com/spreadsheets/d/1W0fYDHy8nePZ-rkqZAX2DVOEufSHe7UJfB7OeC49b1o/export?format=csv&gid=0"
  );
  const text  = await res.text();
  const lines = text.split("\n").filter(Boolean);

  const teamMap = new Map(); // User ‚Üí workerId

  for (let i=1;i<lines.length;i++){
    const [user, wid] = lines[i].split(",");
    if (user && wid){
      teamMap.set(user.trim(), wid.trim());
    }
  }
  return teamMap;
}

function buildExcelRows(rawData, teamMap) {
  const rows = [];

  for (const [user, wid] of teamMap.entries()) {
    const match = rawData.find(r => (r.workerId || "").trim() === wid);
    if (!match) continue;

    rows.push({
      "User": user,
      "Worker ID": wid,
      "Current Earnings": match.currentEarnings || "",
      "Last Month Earnings": match.lastMonthEarnings || "",
      "Next Transfer Date": match.nextTransferDate || match.lastTransferDate || "‚Äî",
      "Last Transfer Amount": match.lastTransferAmount || ""
    });
  }

  return rows;
}

async function exportExcelReport() {
  const teamMap = await loadTeamCSV();
  const all = needsSync() ? await fetchFromFirestore() : loadCache();

  if (!all || all.length === 0) {
    alert("No Firestore data available.");
    return;
  }

  const rows = buildExcelRows(all, teamMap);

  if (rows.length === 0) {
    alert("No matching records found for team sheet.");
    return;
  }

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Earnings");

  XLSX.writeFile(wb, `Daily_Earnings_Report_${today()}.xlsx`);
}

/* ======================================================
   UNDO PANEL HANDLING
====================================================== */
async function handleUndoClick(idx) {
  let history = loadUndoHistory();
  const entry = history[idx];
  if (!entry) return;

  const { id, lastTransferAmount, lastTransferDate } = entry;

  await updateDoc(doc(earningsDB, "earnings_logs", id), {
    lastTransferAmount: lastTransferAmount || "",
    lastTransferDate: lastTransferDate || ""
  });

  history.splice(idx,1);
  saveUndoHistory(history);
  updateUndoButton();
  renderUndoPanel();

  localStorage.removeItem(CACHE_KEY);
  localStorage.removeItem(SYNC_KEY);

  alert("Transfer restored.");
  buildTable();
}

/* ======================================================
   INIT
====================================================== */
window.addEventListener("DOMContentLoaded", () => {
  const nextSyncEl = document.getElementById("next-sync");
  updateCountdown(nextSyncEl);
  setInterval(() => updateCountdown(nextSyncEl), 60000);

  document.getElementById("multiDelete").onclick = multiDeleteTransfers;
  document.getElementById("downloadExcel").onclick = exportExcelReport;

  const undoBtn = document.getElementById("undoBtn");
  const undoPanel = document.getElementById("undoPanel");

  undoBtn.onclick = () => {
    if (undoPanel.style.display === "block") {
      undoPanel.style.display = "none";
    } else {
      renderUndoPanel();
      undoPanel.style.display = "block";
    }
  };

  undoPanel.addEventListener("click", (e) => {
    if (e.target.id === "closeUndo") {
      undoPanel.style.display = "none";
    } else if (e.target.classList.contains("undo-item")) {
      const idx = parseInt(e.target.dataset.idx, 10);
      handleUndoClick(idx);
    }
  });

  updateUndoButton();
  buildTable();
});
</script>

<style>
body {
  font-family:"Segoe UI",Arial,sans-serif;
  background:#f8fafc;
  padding:20px;
}
h1 {
  text-align:center;
  color:#0f62fe;
}
#loading {
  text-align:center;
  color:#6b7280;
  margin-top:10px;
}
#total {
  text-align:center;
  font-size:18px;
  font-weight:bold;
  margin-top:15px;
}
#next-sync {
  text-align:center;
  margin-bottom:10px;
  color:#6b7280;
}

table {
  width:95%;
  margin:15px auto;
  background:#ffffff;
  border-radius:8px;
  border-collapse:collapse;
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}
th,td {
  padding:10px;
  border-bottom:1px solid #e5e7eb;
}
th {
  background:#0f62fe;
  color:#ffffff;
}
.del {
  background:#dc2626;
  color:#ffffff;
  padding:5px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.del:hover {
  background:#b91c1c;
}
.multi-btn, .undo-btn, .excel-btn {
  background:#0d9488;
  color:#ffffff;
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  margin:0 5px;
}
.multi-btn:hover, .undo-btn:hover, .excel-btn:hover {
  background:#0f766e;
}
.undo-btn[disabled] {
  opacity:0.5;
  cursor:not-allowed;
}

/* Undo panel */
.undo-panel {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#ffffff;
  border-radius:8px;
  box-shadow:0 10px 25px rgba(0,0,0,0.2);
  width:420px;
  max-height:60vh;
  display:none;
  z-index:9999;
}
.undo-header {
  padding:10px 14px;
  font-weight:bold;
  border-bottom:1px solid #e5e7eb;
  background:#f3f4f6;
}
.undo-body {
  padding:10px 14px;
  max-height:40vh;
  overflow:auto;
}
.undo-list {
  list-style:none;
  margin:0;
  padding:0;
}
.undo-list li {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 0;
  border-bottom:1px solid #f3f4f6;
}
.undo-entry {
  font-size:13px;
}
.undo-item {
  background:#0d9488;
  color:#ffffff;
  border:none;
  border-radius:6px;
  padding:4px 8px;
  cursor:pointer;
  font-size:12px;
}
.undo-item:hover {
  background:#0f766e;
}
.undo-footer {
  padding:8px 14px;
  border-top:1px solid #e5e7eb;
  text-align:right;
}
.undo-close {
  background:#6b7280;
  color:#ffffff;
  border:none;
  border-radius:6px;
  padding:5px 10px;
  cursor:pointer;
  font-size:13px;
}
.undo-close:hover {
  background:#4b5563;
}
</style>
</head>
<body>

<h1>üí∞ Daily MTurk Earnings Monitor</h1>

<div id="loading">Loading Earnings‚Ä¶</div>
<div id="total"></div>
<div id="next-sync"></div>

<div style="text-align:center;margin:10px 0 15px 0;">
  <button id="multiDelete" class="multi-btn">üóë Delete Selected Transfers</button>
  <button id="undoBtn" class="undo-btn" disabled>‚è™ Undo Deleted Transfers (0)</button>
  <button id="downloadExcel" class="excel-btn">üì• Download Today‚Äôs Excel Report</button>
</div>

<table>
  <thead>
    <tr>
      <th style="text-align:center;">Select</th>
      <th>User</th>
      <th>Worker ID</th>
      <th>Earnings</th>
      <th>Next Transfer Date</th>
      <th>Status</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody id="data-body"></tbody>
</table>

<div id="undoPanel" class="undo-panel"></div>

</body>
</html>
