<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ”¥ MTurk Accepted HITs â€“ Live + Earnings</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot,
      doc, setDoc, deleteDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ===================================================
       ðŸ”¥ FIREBASE CONFIG â€” HITS DATABASE
    =================================================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBkRYurR0cD2VBSNaqT2hyhMu0-AYw6hpw",
      authDomain: "manitasks-a9cd5.firebaseapp.com",
      projectId: "manitasks-a9cd5",
      storageBucket: "manitasks-a9cd5.firebasestorage.app",
      messagingSenderId: "123098755087",
      appId: "1:123098755087:web:2f7f8a04aa7ce47695737a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ===================================================
       ðŸ’° FIREBASE CONFIG â€” EARNINGS DATABASE
    =================================================== */
    import { initializeApp as initEarningsApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

    const earningsConfig = {
      apiKey: "AIzaSyBTFpM3fs7kWBrZL4yOi9tquUTp1HhH7L8",
      authDomain: "mturk-monitordeep.firebaseapp.com",
      projectId: "mturk-monitordeep",
      storageBucket: "mturk-monitordeep.firebasestorage.app",
      messagingSenderId: "505786000194",
      appId: "1:505786000194:web:40b9c9df75d3125f3a99cd"
    };

    const earningsApp = initEarningsApp(earningsConfig, "earningsApp");
    const earningsDB  = getFirestore(earningsApp);

    /* ===================================================
       ðŸŸ¢ PRESENCE TRACKING
    =================================================== */
    const ROOM = "index";
    const HEARTBEAT_MS = 60000;
    const STALE_MS     = 90000;

    const onlineEl = document.querySelector("#onlineCount");
    const presenceCol = collection(db, `rooms/${ROOM}/presence`);
    const sid = crypto.randomUUID?.() ?? Math.random().toString(36).slice(2);
    const meRef = doc(presenceCol, sid);

    async function startPresence() {
      setDoc(meRef, { since: serverTimestamp(), lastActive: serverTimestamp() }, { merge: true }).catch(()=>{});
      setInterval(() => {
        setDoc(meRef, { lastActive: serverTimestamp() }, { merge: true }).catch(()=>{});
      }, HEARTBEAT_MS);

      window.addEventListener("beforeunload", () => {
        deleteDoc(meRef).catch(()=>{});
      });

      onSnapshot(presenceCol, (snap) => {
        const now = Date.now();
        let count = 0;

        snap.forEach(d => {
          const t = d.data()?.lastActive;
          const ms = t?.toMillis?.() ?? (t ? Date.parse(t) : 0);
          if (ms && now - ms <= STALE_MS) count++;
        });

        onlineEl.textContent = `${count} online`;
      });
    }
    startPresence();

    /* ===================================================
       ðŸ’° EARNINGS PANEL + TRANSFER LOGIC
    =================================================== */

    const totalEl = document.createElement("div");
    totalEl.id = "earningsTotal";
    totalEl.style.cssText = `
      font-size:16px;
      font-weight:bold;
      text-align:center;
      margin-top:10px;
      margin-bottom:8px;
    `;

    const subTable = document.createElement("table");
    subTable.id = "qualTable";
    subTable.style.cssText = `
      width:95%;
      margin:0 auto 20px auto;
      border-collapse:collapse;
      background:white;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      display:none;
    `;
    subTable.innerHTML = `
      <thead>
        <tr>
          <th>User</th>
          <th>Worker ID</th>
          <th>Current Earnings ($)</th>
          <th>Next Transfer Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

    /* ðŸ”¥ ALWAYS attach totals below titlebar â€” FIXED */
    function attachTotals() {
      const tb = document.querySelector(".titlebar");
      if (!tb) {
        setTimeout(attachTotals, 100);
        return;
      }

      if (!document.querySelector("#earningsTotal")) {
        tb.insertAdjacentElement("afterend", totalEl);
        totalEl.insertAdjacentElement("afterend", subTable);
      }
    }
    attachTotals();

    function setTotalText(text) {
      totalEl.innerHTML = `
        <a href="#" id="earningsLink" style="color:#15803d;text-decoration:underline;">
          ${text}
        </a>
      `;

      document.querySelector("#earningsLink").onclick = (e) => {
        e.preventDefault();
        subTable.style.display =
          subTable.style.display === "none" ? "table" : "none";
      };
    }

    async function fetchCSV() {
      const res = await fetch(
        "https://docs.google.com/spreadsheets/d/1mf2-AQ59CuboAWz8Fle3qXTFfAI3cnB7mrkqQF1lyCw/export?format=csv&gid=0"
      );
      const text = await res.text();

      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const header = lines[0].split(",").map(h => h.trim().toLowerCase());

      const users = new Set(), workers = new Set();

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",");
        const uidx = header.findIndex(h => h.includes("user"));
        const widx = header.findIndex(h => h.includes("worker"));

        if (uidx >= 0 && cols[uidx]) users.add(cols[uidx].trim());
        if (widx >= 0 && cols[widx]) workers.add(cols[widx].trim());
      }

      return { users, workers };
    }

    async function calcEarnings() {
      try {
        const { users, workers } = await fetchCSV();
        const snap = await getDocs(collection(earningsDB, "earnings_logs"));

        let total = 0;
        let qualifying = [];

        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          const id = docSnap.id;

          const user = (data.user || "").trim();
          const wid = (data.workerId || "").trim();

          const current = parseFloat(data.currentEarnings) || 0;
          const nextDate = data.nextTransferDate || "â€”";

          const lastKnown = parseFloat(data.lastKnownEarnings) || 0;

          /* Firestore-stored transfer history */
          const lastTransferAmount = parseFloat(data.lastTransferAmount) || 0;
          const lastTransferDate   = data.lastTransferDate || "â€”";

          let isTransferred = false;
          let displayAmount = current;
          let displayDate = nextDate;
          let status = "Not Yet";

          /* ðŸ”¥ AUTO-DETECT TRANSFER: current < lastKnown */
          if (current < lastKnown) {
            isTransferred = true;
            displayAmount = lastKnown;       // last amount before drop
            displayDate   = nextDate;        // as per your choice A
            status        = "Transferred";

            /* Store transfer history permanently */
            await setDoc(doc(earningsDB, "earnings_logs", id), {
              lastTransferAmount: lastKnown,
              lastTransferDate: nextDate,
              transferred: true,
              lastKnownEarnings: current
            }, { merge: true });

          } else {
            /* Just update the last known earnings */
            await setDoc(doc(earningsDB, "earnings_logs", id), {
              lastKnownEarnings: current
            }, { merge: true });
          }

          /* Push only if this user is in the CSV list and â‰¥ $8 */
          if ((users.has(user) || workers.has(wid)) && displayAmount >= 8) {
            total += displayAmount;
            qualifying.push({
              user,
              wid,
              val: displayAmount,
              nextDate: displayDate,
              status
            });
          }
        }

        /* Sort: Transferred â†’ Active */
        qualifying.sort((a, b) => {
          if (a.status === "Transferred" && b.status !== "Transferred") return -1;
          if (b.status === "Transferred" && a.status !== "Transferred") return 1;
          return 0;
        });

        setTotalText(
          `Total Earnings (â‰¥ $8 Users): $${total.toFixed(2)} (${qualifying.length} qualified)`
        );

        const tbody = subTable.querySelector("tbody");
        tbody.innerHTML = "";

        qualifying.forEach(q => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${q.user}</td>
            <td>${q.wid}</td>
            <td style="color:#15803d;font-weight:bold">${q.val.toFixed(2)}</td>
            <td>${q.nextDate}</td>
            <td style="font-weight:bold;color:${q.status === "Transferred" ? "#b91c1c" : "#065f46"}">${q.status}</td>
          `;
          tbody.appendChild(tr);
        });

      } catch (e) {
        console.error("âš  Earnings Error:", e);
        setTotalText("âš  Error loading earnings");
      }
    }

    setTimeout(calcEarnings, 1200);
    setInterval(calcEarnings, 5 * 60 * 1000);

    /* ===================================================
       ðŸ”” HIT NOTIFICATIONS
    =================================================== */

    const tableBody = document.querySelector("#hits-body");
    const soundUrl  = "https://www.allbyjohn.com/sounds/mturkscanner/lessthan15Short.mp3";
    let knownIds = new Set();

    function playSound() {
      const a = new Audio(soundUrl);
      a.volume = 0.7;
      a.play().catch(()=>{});
    }

    function renderTable(hits) {
      tableBody.innerHTML = "";
      hits.sort((a, b) => new Date(b.acceptedAt) - new Date(a.acceptedAt));

      hits.forEach(h => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${h.user || "-"}</td>
          <td>${h.workerId || "-"}</td>
          <td>${h.requester || "-"}</td>
          <td>${h.title || "-"}</td>
          <td>${h.reward || 0}</td>
          <td>${h.acceptedAt ? new Date(h.acceptedAt).toLocaleString() : "-"}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    const notifBtn = document.createElement("button");
    notifBtn.textContent = "Enable notifications";
    Object.assign(notifBtn.style, {
      padding: "6px 12px",
      fontSize: "12px",
      borderRadius: "999px",
      border: "1px solid #d1d5db",
      cursor: "pointer",
      background: "#fff"
    });

    document.querySelector(".titlebar").appendChild(notifBtn);

    function updateNotifVisibility() {
      notifBtn.style.display =
        Notification.permission === "granted" ? "none" : "inline-block";
    }
    updateNotifVisibility();

    notifBtn.onclick = async () => {
      try { await Notification.requestPermission(); } catch {}
      updateNotifVisibility();
    };

    const notifiedIds = new Set();

    function notifyNewHit(hit) {
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;

      if (notifiedIds.has(hit.assignmentId)) return;

      const n = new Notification(
        `New HIT â€¢ ${hit.requester || "Requester"}`,
        {
          body: `${hit.title}\nReward: $${hit.reward}`,
          silent: true
        }
      );

      notifiedIds.add(hit.assignmentId);
      setTimeout(() => notifiedIds.delete(hit.assignmentId), 120000);
      setTimeout(() => { try { n.close(); } catch {}; }, 8000);
    }

    onSnapshot(collection(db, "hits"), (snap) => {
      const hits = [];
      const ids = new Set();

      snap.forEach(docSnap => {
        const d = docSnap.data();
        hits.push(d);
        if (d.assignmentId) ids.add(d.assignmentId);
      });

      if (knownIds.size > 0) {
        const newOnes = [...ids].filter(id => !knownIds.has(id));
        if (newOnes.length) {
          playSound();
          newOnes.forEach(id => {
            const h = hits.find(x => x.assignmentId === id);
            if (h) notifyNewHit(h);
          });
        }
      }

      knownIds = ids;
      renderTable(hits);
    });

  </script>

  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f8fafc;
      color: #111827;
      padding: 24px;
    }
    .titlebar {
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    h1 {
      color:#0f62fe;
      margin:0;
      font-size:28px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    #onlineCount {
      font-size:14px;
      color:#6b7280;
      background:#eef2ff;
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:4px 10px;
    }
    table.main {
      width:100%;
      background:white;
      border-radius:8px;
      border-collapse:collapse;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }
    th, td {
      padding:10px 12px;
      border-bottom:1px solid #e5e7eb;
    }
    th {
      background:#0f62fe;
      color:white;
      font-weight:600;
    }
    tr:hover { background:#f3f4f6; }
    #qualTable thead th {
      background:#0f62fe;
      color:white;
      font-weight:600;
    }
    .footer {
      text-align:center;
      margin-top:15px;
      color:#6b7280;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="titlebar">
    <h1>ðŸ”¥ MTurk Accepted HITs (Live Monitor)</h1>
    <span id="onlineCount">0 online</span>
  </div>

  <table class="main">
    <thead>
      <tr>
        <th>User</th>
        <th>Worker ID</th>
        <th>Requester</th>
        <th>Title</th>
        <th>Reward ($)</th>
        <th>Accepted At</th>
      </tr>
    </thead>
    <tbody id="hits-body"></tbody>
  </table>

  <div class="footer">
    Real-time updates â€¢ Plays sound + desktop notifications for new HITs
  </div>
</body>
</html>
