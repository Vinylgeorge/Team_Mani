<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MTurk Monitor â€” Firestore</title>
  <style>
    body {
      font-family: Inter, Roboto, Arial, sans-serif;
      background: #f7f8fa;
      padding: 20px;
      color: #111827;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #e6e9ef;
      padding: 10px;
      font-size: 14px;
    }
    th {
      background: #f1f3f5;
      text-align: left;
      font-weight: 600;
    }
    td.reward {
      text-align: right;
      font-weight: 600;
      color: #047857;
    }
    td.timeleft {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }
    tr:hover { background: #f9fcff; }
    .warn { color: #b45309; }     /* amber */
    .danger { color: #b91c1c; }   /* red */
    .muted { color: #6b7280; }
  </style>
</head>
<body>
  <h1>MTurk Monitor (Realtime)</h1>
  <div id="tableContainer">Loading...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ðŸ”‘ Firebase
    const firebaseConfig = {
      apiKey: "enjoymturk2025",
      authDomain: "mturk-monitor-71203.firebaseapp.com",
      projectId: "mturk-monitor-71203",
      storageBucket: "mturk-monitor-71203.firebasestorage.app",
      messagingSenderId: "149805882414",
      appId: "1:149805882414:web:ad879531a567e0b1b713bf"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const hitsRef = collection(db, "hits");

    const tableContainer = document.getElementById("tableContainer");

    // ðŸ”Š Alarm sound (needs user gesture to unlock autoplay on most browsers)
    const alarm = new Audio("https://www.allbyjohn.com/sounds/mturkscanner/lessthan15Short.mp3");
    alarm.preload = "auto";
    const unlock = () => {
      alarm.play().then(() => {
        alarm.pause(); alarm.currentTime = 0;
      }).catch(() => {});
      document.removeEventListener("click", unlock);
      document.removeEventListener("keydown", unlock);
    };
    document.addEventListener("click", unlock);
    document.addEventListener("keydown", unlock);

    // ðŸ§­ Google Sheet (WorkerID -> User)
    const SHEET_CSV =
      "https://docs.google.com/spreadsheets/d/1oyR6URA8qOmg6Zo90Df4w1h5lckOmjVC_9JrE-AXouM/export?format=csv&gid=0";
    const workerToUser = Object.create(null);

    async function loadUserMapOnce() {
      try {
        const res = await fetch(SHEET_CSV, { cache: "no-store" });
        const csv = await res.text();
        const rows = csv.split(/\r?\n/).map(r => r.split(","));
        if (!rows.length) return;
        const head = rows[0].map(h => h.trim().toLowerCase());
        const widIdx = head.indexOf("workerid");
        const userIdx = head.indexOf("user");
        if (widIdx === -1 || userIdx === -1) return;
        for (let i = 1; i < rows.length; i++) {
          const r = rows[i];
          const wid = (r[widIdx] || "").trim();
          if (!/^[A][A-Z0-9]{12}$/.test(wid)) continue; // A + 12 more = 13 chars total
          workerToUser[wid] = (r[userIdx] || "").trim();
        }
      } catch (e) {
        console.warn("User map load failed:", e);
      }
    }
    await loadUserMapOnce();

    // ðŸ§® Utilities
    function formatReward(value) {
      const num = Number(value);
      return isNaN(num) ? "$0.00" : `$${num.toFixed(2)}`;
    }
    function fmtClock(sec) {
      if (sec == null || !isFinite(sec)) return "-";
      sec = Math.max(0, Math.floor(sec));
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return h > 0
        ? `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`
        : `${m}:${String(s).padStart(2,"0")}`;
    }

    // Keep some state for alarms so we ping every minute (not every second)
    const alarmState = new Map(); // assignmentId -> lastMinuteIntPlayed

    // Weâ€™ll store current snapshot rows to drive the 1s timer without re-querying Firestore
    let currentHits = [];

    function totalSeconds(hit) {
      // Prefer explicit fields if you later add them; for now derive from deadline/acceptedAt
      if (hit.acceptedAt && hit.deadline) {
        const t = (new Date(hit.deadline) - new Date(hit.acceptedAt)) / 1000;
        if (t > 0) return t;
      }
      // fallback: if originalSeconds is present
      if (typeof hit.originalSeconds === "number" && hit.originalSeconds > 0) return hit.originalSeconds;
      return null;
    }

    function remainingSecondsNow(hit) {
      if (!hit.deadline) return hit.remainingSeconds ?? null;
      const sec = Math.floor((new Date(hit.deadline) - Date.now()) / 1000);
      return Math.max(0, sec);
    }

    function rowIntensity(rem, total) {
      if (rem == null) return "";
      if (total == null) {
        // without total, just show red when under 2 minutes
        if (rem <= 120) return "danger";
        if (rem <= 300) return "warn";
        return "";
      }
      const ratio = rem / total;
      if (ratio <= 0.10) return "danger";
      if (ratio <= 0.25) return "warn";
      return "";
    }

    function buildTable(hits) {
      if (!hits.length) {
        tableContainer.innerHTML = "<p>No HITs in queue</p>";
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Worker ID</th>
              <th>Requester</th>
              <th>Title</th>
              <th>Reward</th>
              <th>Time Left</th>
              <th>Accepted At</th>
            </tr>
